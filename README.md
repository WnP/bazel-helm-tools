# Helm Tools for Bazel

Strongly-typed, functional Bazel rules for managing Helm charts from repositories, local directories, or Git sources with comprehensive validation and platform-aware binary management.

## Table of Contents

- [Overview](#overview)
- [Features](#features)
- [Project Structure](#project-structure)
- [Installation](#installation)
  - [Using Bazel Modules (Bazel 6+)](#using-bazel-modules-bazel-6)
  - [Using WORKSPACE (Legacy)](#using-workspace-legacy)
- [Quick Start](#quick-start)
- [Usage Examples](#usage-examples)
  - [Repository Chart Examples](#repository-chart-examples)
  - [Local Chart Example](#local-chart-example)
  - [Advanced Local Chart Example](#advanced-local-chart-example)
  - [Composing with Git Tools](#composing-with-git-tools)
- [API Reference](#api-reference)
  - [Rules and Macros](#rules-and-macros)
  - [Functions](#functions)
- [Providers](#providers)
- [Testing](#testing)
  - [Running Tests](#running-tests)
  - [Writing Tests](#writing-tests)
- [Troubleshooting](#troubleshooting)
  - [Common Issues](#common-issues)
- [Best Practices](#best-practices)
- [Contributing](#contributing)
- [License](#license)

## Overview

The Helm Tools module provides a comprehensive solution for managing Helm charts within Bazel builds. It supports three primary chart sources:

1. **Helm Repositories**: Install charts from Helm repositories using the `helm_repository` macro
2. **OCI Registries**: Deploy charts directly from OCI-compliant registries 
3. **Local Charts**: Deploy charts from your repository or generated by build rules

Key benefits include:
- **Repository Management**: Define and reuse Helm repositories across multiple releases
- **OCI Registry Support**: Direct deployment from OCI registries without repository setup
- **Local Chart Management**: Deploy charts from your repository or generated by build rules
- **Platform-Aware Binary Management**: Automatically downloads correct Helm binary for Linux, macOS, Windows
- **Strongly-Typed Providers**: Type-safe configuration with compile-time validation
- **Pure Functional Implementation**: No side effects, predictable behavior
- **Composable Architecture**: Combine with `git_tools` for Git-based chart support

Use this module when you need reproducible Helm deployments with build-time validation and proper dependency tracking.

## Features

- **Repository Chart Support**: Install charts from any Helm repository (public or private)
- **Local Chart Management**: Deploy and manage charts from your repository
- **Platform-Aware Binary Management**: Automatic Helm binary selection
- **Strongly-Typed Providers**: Type-safe configuration with validation
- **Functional Programming**: Pure functions with immutable data structures
- **Comprehensive Validation**: Validates release names, namespaces, versions
- **Multiple Operations**: Install, upgrade, uninstall, status, and values retrieval
- **Module Extensions**: Configure Helm version via bzlmod
- **Hermetic Builds**: Ensures reproducible deployments
- **Composable Design**: Works seamlessly with other Bazel modules

## Project Structure

```
helm_tools/
├── MODULE.bazel              # Module definition with dependencies
├── BUILD.bazel               # Root build configuration
├── README.md                 # This documentation file
├── CHANGELOG.md              # Version history and changes
├── defs.bzl                  # Public API - helm_release macro
├── extensions.bzl            # Module extension for Helm version configuration
├── private/                  # Private implementation (internal use only)
│   ├── BUILD.bazel           # Private build configuration
│   ├── providers.bzl         # Provider definitions for type safety
│   ├── validation.bzl        # Input validation functions
│   ├── implementation.bzl    # Core rule implementations
│   ├── helm_download.bzl     # Platform-aware Helm binary download
│   ├── go/                   # Go implementation for Helm operations
│   │   ├── cmd/              # CLI applications
│   │   ├── pkg/              # Shared packages
│   │   └── internal/         # Internal utilities
│   └── tests/                # Unit tests
│       ├── BUILD.bazel       # Test configuration
│       ├── test_helpers.bzl  # Shared test utilities
│       ├── providers_test.bzl    # Provider tests
│       ├── validation_test.bzl   # Validation tests
│       └── implementation_test.bzl # Implementation tests
└── examples/                 # Usage examples
    ├── local_chart/          # Local chart deployment example
    │   ├── BUILD.bazel
    │   └── charts/           # Local chart directory
    └── git_integration/      # Git + Helm composition example
        └── BUILD.bazel
```

## Installation

### Using Bazel Modules (Bazel 6+)

Add to your `MODULE.bazel`:

```starlark
bazel_dep(name = "helm_tools", version = "2.0.0")

# Configure Helm version (optional, defaults to v3.13.3)
helm = use_extension("@helm_tools//:extensions.bzl", "helm")
helm.configure(
    version = "v3.13.3",
    sha256 = "...",  # Optional but recommended
)
use_repo(helm, "helm_binary")
```

For local development:

```starlark
local_path_override(
    module_name = "helm_tools",
    path = "tools/helm_tools",
)
```

### Using WORKSPACE (Legacy)

Add to your `WORKSPACE`:

```starlark
load("@bazel_tools//tools/build_defs/repo:http.bzl", "http_archive")

http_archive(
    name = "helm_tools",
    sha256 = "...",
    urls = ["https://github.com/yourorg/helm_tools/releases/download/v2.0.0/helm_tools.tar.gz"],
)

load("@helm_tools//:deps.bzl", "helm_tools_dependencies")
helm_tools_dependencies()

load("@helm_tools//:setup.bzl", "helm_tools_setup")
helm_tools_setup(version = "v3.13.3")
```

## Quick Start

Install a chart from a Helm repository:

```starlark
load("@helm_tools//:defs.bzl", "helm_repository", "helm_release")

# Define the repository
helm_repository(
    name = "prometheus_repo",
    url = "https://prometheus-community.github.io/helm-charts",
)

# Install Prometheus from the repository
helm_release(
    name = "prometheus",
    chart = "kube-prometheus-stack",  # Chart name from repository
    repo_name = ":prometheus_repo",  # Reference the repository
    chart_version = "51.3.0",  # Pin specific version
    namespace = "monitoring",
    values_file = ":prometheus-values.yaml",
)
```

Deploy your application:

```bash
# Install the release
bazel run //:prometheus_install

# Check status
bazel run //:prometheus_status

# Upgrade the release
bazel run //:prometheus_upgrade

# Get deployed values
bazel run //:prometheus_values

# Uninstall if needed
bazel run //:prometheus_uninstall
```

## Usage Examples

### Repository Chart Examples

#### Using helm_repository for HTTP/HTTPS Repositories

For HTTP/HTTPS repositories, you must first define the repository using `helm_repository`, then reference it:

```starlark
# BUILD.bazel
load("@helm_tools//:defs.bzl", "helm_repository", "helm_release")

# Step 1: Define repositories
helm_repository(
    name = "prometheus_repo",
    url = "https://prometheus-community.github.io/helm-charts",
)

helm_repository(
    name = "bitnami_repo",
    url = "https://charts.bitnami.com/bitnami",
)

helm_repository(
    name = "nginx_repo",
    url = "https://kubernetes.github.io/ingress-nginx",
)

# Step 2: Deploy charts from defined repositories
helm_release(
    name = "prometheus",
    chart = "kube-prometheus-stack",
    repo_name = ":prometheus_repo",  # Reference the repository
    chart_version = "51.3.0",
    namespace = "monitoring",
    values_file = ":prometheus-values.yaml",
    create_namespace = True,
)

helm_release(
    name = "nginx_ingress",
    chart = "ingress-nginx",
    repo_name = ":nginx_repo",  # Reference the repository
    chart_version = "4.7.1",
    namespace = "ingress-nginx",
    create_namespace = True,
    wait = True,
)

helm_release(
    name = "postgres",
    chart = "postgresql",
    repo_name = ":bitnami_repo",  # Reference the repository
    chart_version = "13.2.10",
    namespace = "database",
    values_file = ":postgres-config.yaml",
    wait = True,
    timeout = "10m",
)
```

#### Using Private Repositories with Authentication

```starlark
helm_repository(
    name = "private_repo",
    url = "https://charts.example.com",
    username = "myuser",
    password = "mypass",
    ca_file = ":ca-bundle.pem",  # Optional CA certificate
)

helm_release(
    name = "private_app",
    chart = "my-app",
    repo_name = ":private_repo",
    chart_version = "2.1.0",
    namespace = "production",
)
```

#### Direct OCI and File URLs

OCI and file:// URLs can be used directly with `repo_url` (no `helm_repository` needed):

```starlark
# OCI Registry (Helm 3.8+)
helm_release(
    name = "oci_chart",
    chart = "my-chart",
    repo_url = "oci://ghcr.io/organization/charts",  # Direct OCI URL
    chart_version = "1.0.0",
    namespace = "default",
    values_file = ":oci-values.yaml",
)

# Local file repository
helm_release(
    name = "local_repo_chart",
    chart = "my-local-chart",
    repo_url = "file:///path/to/local/repo",  # Direct file URL
    chart_version = "0.1.0",
    namespace = "dev",
)
```

### Local Chart Example

Deploy a chart from your repository:

```starlark
# BUILD.bazel
load("@helm_tools//:defs.bzl", "helm_release")

# Deploy a local chart
helm_release(
    name = "webapp",
    chart = "//services/webapp/chart",  # Path to local chart directory
    namespace = "web",
    values_file = "//services/webapp:prod-values.yaml",
    wait = True,
    timeout = "5m",
)
```

Chart structure:
```
services/webapp/
├── BUILD.bazel
├── prod-values.yaml
└── chart/
    ├── Chart.yaml
    ├── values.yaml
    └── templates/
        ├── deployment.yaml
        ├── service.yaml
        └── ingress.yaml
```

### Advanced Local Chart Example

Production deployment with custom configuration:

```starlark
# BUILD.bazel
load("@helm_tools//:defs.bzl", "helm_release")

# Generate values file from template
genrule(
    name = "generate_values",
    srcs = ["values.template.yaml"],
    outs = ["values.yaml"],
    cmd = "envsubst < $< > $@",
)

helm_release(
    name = "production_app",
    chart = "//charts/application",
    namespace = "production",
    values_file = ":generate_values",  # Use generated values
    create_namespace = True,
    wait = True,
    timeout = "10m",
    atomic = True,  # Rollback on failure
    tags = ["manual", "production"],
)
```

### Composing with Git Tools

For Git-based charts, combine `helm_tools` with `git_tools`:

```starlark
# BUILD.bazel
load("@git_tools//:defs.bzl", "git_repository")
load("@helm_tools//:defs.bzl", "helm_release")

# Pattern 1: Chart is at repository root (Chart.yaml at root)
git_repository(
    name = "my_chart",
    url = "https://github.com/org/helm-chart.git",
    branch = "main",
)

helm_release(
    name = "my_app",
    chart = ":my_chart",  # Archive has Chart.yaml at root
    namespace = "default",
)

# Pattern 2: Chart is in a subdirectory - use sparse_paths!
# IMPORTANT: Single sparse_path archives from that directory
git_repository(
    name = "cilium_repo",
    url = "https://github.com/cilium/cilium.git",
    branch = "main",
    sparse_paths = ["install/kubernetes/cilium"],  # Archives from this dir!
)

helm_release(
    name = "cilium",
    chart = ":cilium_repo",  # Archive has Chart.yaml at root!
    namespace = "kube-system",
    values_file = ":cilium-values.yaml",
)
```

**Key insight**: When using `sparse_paths` with a single path, git_repository archives from that directory, putting Chart.yaml at the archive root - exactly what Helm expects!

For a more advanced example with private repositories:

```starlark
# BUILD.bazel
load("@git_tools//:defs.bzl", "git_repository")
load("@helm_tools//:defs.bzl", "helm_release")

# Clone private chart repository via SSH
git_repository(
    name = "private_charts",
    url = "git@gitlab.company.com:k8s/charts.git",
    branch = "main",
    sparse_paths = ["stable/app-chart"],  # Chart in subdirectory
)

# Deploy from the archive
helm_release(
    name = "private_app",
    chart = ":private_charts",  # Chart.yaml at archive root
    namespace = "production",
    values_file = ":prod-values.yaml",
    create_namespace = True,
    wait = True,
    atomic = True,
)
    output = "nginx-chart.tar.gz",
    paths = ["bitnami/nginx"],
)

# Use the archive (after extraction)
genrule(
    name = "extract_chart",
    srcs = [":chart_archive"],
    outs = ["nginx-chart"],
    cmd = "tar -xzf $< -C $(@D)",
)

helm_release(
    name = "nginx_from_archive",
    chart = ":extract_chart/bitnami/nginx",
    namespace = "web-archive",
    values_file = ":nginx-values.yaml",
)
```

## API Reference

### Rules and Macros

#### `helm_repository`

```starlark
helm_repository(name, url, ca_file, cert_file, force_update,
                insecure_skip_tls_verify, no_update, password, username,
                visibility, tags, **kwargs)
```

Defines a Helm repository that can be referenced by multiple `helm_release` targets.

**Important:** This macro is **required** for HTTP/HTTPS repositories. OCI and file:// URLs can be used directly with `repo_url` parameter in `helm_release`.

**Generated Output:**
- `{name}`: Target that adds the repository to Helm
- `{name}_config.json`: Repository configuration file

**Attributes:**

| Attribute | Type | Default | Required | Description |
|-----------|------|---------|----------|-------------|
| name | string | - | Yes | Target name for the repository |
| url | string | - | Yes | Repository URL (HTTP/HTTPS) |
| ca_file | label | None | No | CA bundle for certificate verification |
| cert_file | label | None | No | Client certificate for authentication |
| force_update | bool | False | No | Force update even if exists |
| insecure_skip_tls_verify | bool | False | No | Skip TLS verification |
| no_update | bool | False | No | Skip repository update after adding |
| password | string | None | No | Repository password |
| username | string | None | No | Repository username |
| visibility | list | None | No | Target visibility |
| tags | list | None | No | Target tags |

**Example:**

```starlark
helm_repository(
    name = "bitnami",
    url = "https://charts.bitnami.com/bitnami",
)

helm_release(
    name = "nginx",
    chart = "nginx",
    repo_name = ":bitnami",  # Reference the repository
    chart_version = "13.2.10",
    namespace = "web",
)
```

#### `helm_release`

```starlark
helm_release(name, chart, values_file, namespace, create_namespace,
             release_name, wait, timeout, atomic, force, repo_url,
             repo_name, chart_version, visibility, tags, **kwargs)
```

Creates targets for managing a Helm release following functional programming principles.

**Chart Sources:**
1. **Local charts**: Path to chart directory (e.g., `//charts/my-app`)
2. **Repository charts**: Chart name with `repo_name` reference (for HTTP/HTTPS)
3. **OCI charts**: Chart name with `repo_url` starting with `oci://`
4. **File charts**: Chart name with `repo_url` starting with `file://`

**Generated Targets:**
- `{name}_install`: Installs the Helm chart
- `{name}_upgrade`: Upgrades the Helm chart
- `{name}_uninstall`: Uninstalls the Helm chart
- `{name}_status`: Checks release status
- `{name}_values`: Gets release values

**Attributes:**

| Attribute | Type | Default | Required | Description |
|-----------|------|---------|----------|-------------|
| name | string | - | Yes | Base name for generated targets |
| chart | string/label | - | Yes | Chart name or path to local chart |
| values_file | label | None | No | Values YAML file |
| namespace | string | "default" | No | Kubernetes namespace |
| create_namespace | bool | True | No | Create namespace if missing |
| release_name | string | name | No | Helm release name |
| wait | bool | True | No | Wait for release to be ready |
| timeout | string | "10m" | No | Operation timeout |
| atomic | bool | False | No | Rollback on failure |
| force | bool | False | No | Force resource updates |
| repo_url | string | None | No | **OCI or file:// URL only** (not HTTP/HTTPS) |
| repo_name | label | None | No | Reference to helm_repository target |
| chart_version | string | None | No | Specific chart version |
| visibility | list | None | No | Target visibility |
| tags | list | None | No | Target tags |

**Important:** 
- `repo_url` only supports `oci://` and `file://` URLs
- For HTTP/HTTPS repositories, use `helm_repository` first, then reference with `repo_name`
- `repo_url` and `repo_name` are mutually exclusive

**Examples:**

```starlark
# Local chart
helm_release(
    name = "webapp",
    chart = "//charts/webapp",
    namespace = "web",
    values_file = ":custom_values.yaml",
)

# Repository chart (HTTP/HTTPS)
helm_repository(
    name = "bitnami",
    url = "https://charts.bitnami.com/bitnami",
)

helm_release(
    name = "nginx",
    chart = "nginx",
    repo_name = ":bitnami",  # Reference the repository
    chart_version = "13.2.10",
    namespace = "web",
)

# OCI registry (direct)
helm_release(
    name = "oci_app",
    chart = "my-app",
    repo_url = "oci://ghcr.io/org/charts",  # Direct OCI URL
    chart_version = "1.0.0",
    namespace = "production",
)
```

### Functions

The module exposes validation functions for use in custom rules:

- `validate_semantic_version(version)`: Validates semantic version format
- `validate_helm_release_name(name)`: Validates Helm release name
- `validate_namespace(namespace)`: Validates Kubernetes namespace
- `validate_timeout(timeout)`: Validates timeout format

## Providers

### `HelmVersionInfo`

Information about the Helm binary version.

**Fields:**

| Field | Type | Description |
|-------|------|-------------|
| version | string | Semantic version (e.g., "v3.13.3") |
| binary | label | Label of the Helm binary |
| sha256 | string | SHA256 checksum (optional) |

### `HelmChartInfo`

Information about a Helm chart.

**Fields:**

| Field | Type | Description |
|-------|------|-------------|
| name | string | Chart name |
| version | string | Chart version (optional) |
| path | string | Local path to chart |
| dependencies | tuple | Chart dependencies (immutable) |
| values_schema | dict | Expected values schema |

### `HelmReleaseInfo`

Information about a deployed Helm release.

**Fields:**

| Field | Type | Description |
|-------|------|-------------|
| name | string | Release name |
| namespace | string | Kubernetes namespace |
| chart | HelmChartInfo | Chart information |
| values | dict | Release values |
| status | string | Release status |
| revision | int | Release revision number |
| notes | string | Release notes (optional) |

## Testing

### Running Tests

```bash
# Run all tests
bazel test @helm_tools//private/tests:all_tests

# Run specific test suite
bazel test @helm_tools//private/tests:validation_tests
bazel test @helm_tools//private/tests:providers_tests
bazel test @helm_tools//private/tests:implementation_tests

# Run with coverage
bazel coverage @helm_tools//private/tests:all_tests
```

### Writing Tests

Use the provided test helpers:

```starlark
load("@helm_tools//private/tests:test_helpers.bzl", "create_test_provider")

def _my_test_impl(ctx):
    env = unittest.begin(ctx)

    # Use test helpers
    provider = create_test_provider()

    # Your assertions
    asserts.equals(env, expected, actual)

    return unittest.end(env)

my_test = unittest.make(_my_test_impl)
```

## Troubleshooting

### Common Issues

#### Issue: "Chart directory not found"
**Cause:** The specified chart path doesn't exist or is incorrect
**Solution:** Verify the chart path is correct and accessible:
```starlark
helm_release(
    chart = "//path/to/chart",  # Must be a valid Bazel label or path
    ...
)
```

#### Issue: "Release already exists"
**Cause:** Attempting to install an existing release
**Solution:** Use the upgrade target instead: `bazel run //:my_app_upgrade`

#### Issue: "Namespace not found"
**Cause:** Namespace doesn't exist and create_namespace is false
**Solution:** Set `create_namespace = True` or create the namespace manually

#### Issue: "Timeout waiting for condition"
**Cause:** Release taking longer than timeout to become ready
**Solution:** Increase timeout: `timeout = "20m"`

#### Issue: "Chart validation failed"
**Cause:** The chart structure is invalid
**Solution:** Verify Chart.yaml exists and is valid YAML

## Best Practices

1. **Local Charts**: Keep charts in your repository for version control and reproducibility
2. **Values Files**: Store environment-specific values in separate YAML files
3. **Namespace Isolation**: Use different namespaces for different environments
4. **Atomic Deployments**: Use `atomic = True` for production deployments
5. **Timeouts**: Set appropriate timeouts based on chart complexity
6. **Validation**: Use the provided validation functions in custom rules
7. **Testing**: Test charts locally before deploying to production
8. **Documentation**: Document your charts and their configuration options
9. **Repository Integration**: Use built-in repository support for external charts, with secure authentication and version management

## Contributing

We welcome contributions! Please see our [Contributing Guide](CONTRIBUTING.md) for details.

### Development Setup

1. Clone the repository
2. Install Bazel or Bazelisk
3. Run tests: `bazel test //private/tests:all_tests`

### Submitting Changes

1. Fork the repository
2. Create a feature branch
3. Add tests for new functionality
4. Ensure all tests pass
5. Submit a pull request

## License

Apache License 2.0 - see [LICENSE](LICENSE) file for details.
